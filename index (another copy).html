<script src="js/d3.v3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script src="js/queue.v1.min.js"></script>
<script src="js/jquery-2.2.1.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/d3.geo.projection.v0.min.js"></script>
<script src="js/geostats.min.js"></script>
<link href="css/style.css" rel="stylesheet" type="text/css" >
<link href="css/jquery-ui.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/colorbrewer.css">   


<html>
<head>
<meta charset="UTF-8">
</head>   
<body> 
<div id="header"></div>
<div id="menu"></div>
<div id="map"></div>
</body>    
</html>


<script>

// ***************************************************************************   
// HEADER ********************************************************************
// *************************************************************************** 

var header = d3.select("#header");
header.append("p")
	.attr("class","item-header")
	.append("a")
 	.attr("href", "https://github.com/neocarto/geomedia")
	.attr("target","_blank")
	.html("Sources");
header.append("p")
	.attr("class","item-header")
	.append("a")
 	.attr("href", "#")
	.attr("target","_blank")
	.html("Methods");
header.append("p")
	.attr("class","item-logo")
	.html("<img src='img/geomedia_logo.png'></img>");



// ***************************************************************************   
// MENU **********************************************************************
// *************************************************************************** 

var menu =  d3.select("#menu");


// Newspapers

menu.append("h2").html("<li><span id ='rss-title'>Newspapers</span></li>")
menu.append("div").attr("id","menu-rss").append("select")
	.attr("id","select-rss")
	.attr("style","width:250px ; height:100px");


$.getJSON('database/output/feeds.json', null, function(data) {
  fillSelect(data);
});

$( "#select-rss" ).selectmenu();
function fillSelect(data) {
    $.each(data, function(i, item) {
    $( "#select-rss" ).append("<option value = "+item.id+">"+item.name+"</option>");
  });
}
menu.append("div").attr("id","spacerss").append("br")
menu.append("div").attr("id","allrss")
d3.select("#allrss").html("<input type='checkbox' id='checkrss' name='checkrss'><label for='checkrss'>Select all</label>")
$( "#allrss" ).buttonset();

// Countries

menu.append("h2").html("<li><span id ='countries-title'>Countries</span></li>")
menu.append("div").attr("id","menu-countries").append("select")
	.attr("id","select-countries")
	.attr("style","width:250");
menu.append("div").attr("id","spacecountries").append("br")
menu.append("div").attr("id","allcountries")
d3.select("#allcountries").html("<input type='checkbox' id='checkcountries' name='checkcountries'><label for='checkcountries'>Select all</label>")
$( "#allcountries" ).buttonset();

$.getJSON('database/output/countries.json', null, function(data) {
  fillSelect2(data);
});

$( "#select-countries" ).selectmenu();
function fillSelect2(data) {
    $.each(data, function(i, item) {
    $( "#select-countries" ).append("<option value = "+item.id+">"+item.name+"</option>");
  });
}



// Weeks
myweek=1;
menu.append("div").attr("id","menu-date-title").append("h2").html("<li>Time (<span id='nbweek'>"+myweek+"</span>)</li>")
menu.append("div").attr("id","menu-date")


  $(function() {
    $( "#menu-date" ).slider({
      range: "max",
      min: 1,
      max: 52,
      value: 1,
      slide: function( event, ui ) {
        $( "#nbweek" ).html( ui.value );
	myweek =  ui.value;
      }
    });
  $( "#nbweek" ).val( $( "#menu-date" ).slider( "value" ) );

  });
menu.append("div").attr("id","spaceweeks").append("br")

menu.append("div").attr("id","allweeks")
d3.select("#allweeks").html("<input type='checkbox' id='checkweek' name='checkweek'><label for='checkweek'>Select all</label>")
$( "#allweeks" ).buttonset();


// Modele
menu.append("h2").html("Model")
menu.append("div").attr("id","radioset")
d3.select("#radioset").html("<input type='radio' id='radio1' name='radio' checked='checked'><label for='radio1'>Gravitaire</label><input type='radio' id='radio2' name='radio'><label for='radio2'>Aléatoire</label><input type='radio' id='radio3' name='radio'><label for='radio3'>Model 3</label>")
$( "#radioset" ).buttonset();

// Map configuration80000 jeunes français, 10% d'une génération qui émigre" 
menu.append("br")
menu.append("br")
menu.append("h2").html("Map configuration")

// Rotate
menu.append("li").html("base map rotation")
menu.append("input").attr("type", "range").attr("id","form_rotate").attr("value",0).attr("min",0).attr("max",360).attr("step",1)

d3.select("#form_rotate").on("input", function() { 
    projection.rotate([eval(this.value),0,0]);
    svg.selectAll("path").attr("d", path);
    svg.select("#propsymbols").selectAll("circle")
	//.attr("cx", function(d) { return path.centroid(d)[0]; })
	//.attr("cy", function(d) { return path.centroid(d)[1]; })
    .attr("cx", function(d) {  if(typeof x.get(d[0]) != 'undefined') {return projection(x.get(d[0]))[0]} else {return "NaN"} })
    //.attr("cy", function(d) {  if(typeof x.get(d[0]) != 'undefined') {return projection(x.get(d[0]))[1]} else {return "NaN"} })
});
    
    


    // Sizes
menu.append("li").html("Symboles sizes")
menu.append("input").attr("type", "range").attr("id","form_sizes").attr("value",1).attr("min",0.1).attr("max",2).attr("step",0.1)
d3.select("#form_sizes").on("input", function() {
    var k = this.value;
    d3.select("#propsymbols").selectAll("circle")
        .attr("r", function(d) { return radius(d[1]*k*size)} );
    }); 





// Menu jquery interactivity

$("#checkrss").change(function() {
    if(this.checked) {
	$("#menu-rss").hide();
	$("#spacerss").hide();
	$("#rss-title").empty();
	$("#rss-title").append("Newspapers (All)");
	}
    else {
	$("#menu-rss").show();
	$("#spacerss").show();
	$("#rss-title").empty();
	$("#rss-title").append("Newspapers");
	}
});

$("#checkcountries").change(function() {
    if(this.checked) {
	$("#menu-countries").hide();
	$("#spacecountries").hide();
	$("#countries-title").empty();
	$("#countries-title").append("Countries (All)");
	}
    else {
	$("#menu-countries").show();
	$("#spacecountries").show();
	$("#countries-title").empty();
	$("#countries-title").append("Countries");
	}
});


$("#checkweek").change(function() {
    if(this.checked) {
	$("#menu-date").hide();
	$("#spaceweeks").hide();
	$("#nbweek").empty();
	$("#nbweek").append("All");
	}
    else {
	$("#menu-date").show();
	$("#spaceweeks").show();
	$("#nbweek").empty();
	$("#nbweek").append(myweek);	
	}


});




// catch menu values for d3


// ***************************************************************************   
// MAP ***********************************************************************
// *************************************************************************** 


// PARAMETRE GÉNÉRAUX **************************************

var width = 1000,
    height = 600;

    
var radius = d3.scale.sqrt()


var svg = d3.select("#map").append("svg")
      .attr("width", width)
      .attr("height", height)

 var radialGradient = svg.append("defs").append("radialGradient").attr("id", "radial-gradient");
 radialGradient.append("stop").attr("offset", "50%").attr("stop-color", "#f3f6fa");
 radialGradient.append("stop").attr("offset", "100%").attr("stop-color", "#d3e0fa");  

var projection = d3.geo.armadillo()
    .scale(237)
    .translate([500,400])
    .parallel(20)
    .rotate([0, 0, 0])
    .precision(.1);

var path = d3.geo.path()
    .projection(projection);

var graticule = d3.geo.graticule();

var defs = svg.append("defs");

defs.append("clipPath")
    .attr("id", "clip")
  .append("use")
    .attr("xlink:href", "#sphere");

svg.append("defs").append("path")
    .datum({type: "Sphere"})
    .attr("id", "sphere")
    .attr("d", path)
    .style("fill", "url(#radial-gradient)")
    .style("stroke","none") ;

svg.append("use")
    .attr("class", "stroke")
    .attr("xlink:href", "#sphere");

svg.append("g").attr("id","grat").append("path")
    .datum(graticule)
    .attr("class", "graticule")
    .attr("clip-path", "url(#clip)")
    .attr("d", path);




// BASE MAP **************************************



 function plotBasemap() {

	// Files to load    
	    queue()
	    .defer(d3.json, "database/geom/world.topojson")
	    .await(ready);

	function ready(error,world) {
	  if (error) throw error;

	svg.append("g")
		.attr("id","countries")
		.attr("class", "land")
		.selectAll(".subunit")
		.data(topojson.feature(world, world.objects.w).features)
		.enter().append("path")
		.attr("d", path)
		.attr("clip-path", "url(#clip)")  

	svg.append("g")
	      .attr("id","coasts")
	      .append("path")
	      .datum(topojson.merge(world, world.objects.w.geometries))
	      .attr("class", "coasts")
	      .attr("d", path)
	      .attr("clip-path", "url(#clip)")  

	  x = d3.map()	
	  svg.data(topojson.feature(world,world.objects.c).features)
		.enter().append("circle")
		.attr("id", function(d) { x.set(d.id, path.centroid(d)); return d.id; })
	 	.attr("cx", function(d) { return path.centroid(d)[0]; })
	 	.attr("cy", function(d) { return path.centroid(d)[1]; })
        .attr("r", 0);


} 
}


plotBasemap()

// TEXTES ET LOGOS **************************************

    // Source
svg.append("g").append("text").text("Source: Nicolas Lambert, 2016")
        .attr("x", 0+5).attr("y", height-5)
        .style({"font-size":"12px", "fill":"#919091","font-family":"tahoma, geneva, sans-serif","font-style":"italic"});
 
    // Logo
svg.append("g").append("svg:image")
        .attr('x',773)
        .attr('y',500)
        .attr('width', 120)
        .attr('height', 100)
        .attr("xlink:href","img/logo_riate.svg");


   // map title
 var maptitle ="Title";
    var posx = width/2; var posy = 50;
    svg.append("g").append("text").text(maptitle)
        .attr("x", posx).attr("y", posy)
        .style({"font-size":"25px", "fill":"#6B8087","font-family":"arial, tahoma, geneva, sans-serif","font-style":"bold"})
	.attr("text-anchor","middle");


// CIRCLES PROPORTIONNELS

function plotPropCircles(file,k,field, pallette) {

	   var stockById = d3.map()
       stockById2 = [];
	   var myfieldstock = "d."+field;

	// Files to load    
	 queue()
  	 .defer(d3.tsv, file, function(d) { stockById2.push([d.id, +eval(myfieldstock)])  })
     .await(ready);
	function ready(error, data) {

	  if (error) throw error;
	stockById2 = stockById2.sort(function(a,b){return a[1] < b[1]})
	  svg.append("g")
		.attr("id", "propsymbols")
		.attr("class"," bubble")
		.selectAll("circle")
		.data(stockById2)
		.enter().append("circle")
		.attr("id", function(d) { return d[0]; })
	 	.attr("cx", function(d) { if(typeof x.get(d[0]) != 'undefined') {return x.get(d[0])[0]} else {return "NaN"} })
		.attr("cy", function(d) { if(typeof x.get(d[0]) != 'undefined') {return x.get(d[0])[1]} else {return "NaN"} })
        .attr("r", function(d) { return radius(d[1]*k); })
        .on('mouseover', function(d){
            d3.select(this).style({fill: "#ffc914", cursor:"pointer"});
            //d3.select("#dyntext_nuts").text(d.properties.name);
            //d3.select("#dyntext_gdp").text("GDP: "+d3.round(stockById.get(d.id), 2)+ " million euros");
            //d3.select("#dyntext_gdpinh").text("GDP per capita.: "+d3.round(rateById.get(d.id), 0)+ " euros per inh.");
        })
        .on('mouseout', function(d){
            d3.select(this).transition().duration(250).style("fill", function(d) {d.class});
        })
        .on('click', function(d){
            alert("TODO: Display WordCloud for "+d[0]);
        });
        

        
} 
  size = eval(k);

}

plotPropCircles("database/test/datatest1.tsv",0.3,"stock")

</script>