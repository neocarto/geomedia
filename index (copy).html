<script src="js/d3.v3.min.js"></script>
<script src="js/topojson.v1.min.js"></script>
<script src="js/queue.v1.min.js"></script>
<script src="js/jquery-2.2.1.min.js"></script>
<script src="js/jquery-ui.min.js"></script>
<script src="js/d3.layout.cloud.js"></script>
<script src="js/d3.geo.projection.v0.min.js"></script>
<script src="js/geostats.min.js"></script>
<script src="js/tooltip.js"></script>
<link href="css/style.css" rel="stylesheet" type="text/css" >
<link href="css/jquery-ui.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="css/colorbrewer.css">   


<html>
<head>
<meta charset="UTF-8">
</head>   
<body> 
<div id="header"></div>
<div id="menu"></div>
<div id="map"></div>
<div id="dialog"></div>
</body>    
</html>


<script>

// ***************************************************************************   
// GLOBAL PARAMETERS OF THE MAP **********************************************
// *************************************************************************** 
var formsize = 1;
var width = 1000, height = 600;
    
var radius = d3.scale.sqrt()

var svg = d3.select("#map").append("svg").attr("width", width).attr("height", height)

var radialGradient = svg.append("defs").append("radialGradient").attr("id", "radial-gradient");
radialGradient.append("stop").attr("offset", "50%").attr("stop-color", "#f3f6fa");
radialGradient.append("stop").attr("offset", "100%").attr("stop-color", "#d3e0fa"); 

var radialGradient2 = svg.append("defs").append("radialGradient");
radialGradient2.attr("id", "radial-gradient2");
radialGradient2.append("stop").attr("offset", "20%").attr("stop-color", "#ef5a5a");
radialGradient2.append("stop").attr("offset", "100%").attr("stop-color", "#d10303");      
 

var projection = d3.geo.armadillo()
    .scale(237)
    .translate([500,400])
    .parallel(20)
    .rotate([0, 0, 0])
    .precision(.1);

var path = d3.geo.path().projection(projection);

// FILES TO LOAD 

symbols = d3.map()
labels = d3.map()	

queue()
	.defer(d3.json, "files/geom/world.topojson")
	.await(ready);
        function ready(error,world,countries) {
	if (error) throw error;
     	svg.data(topojson.feature(world,world.objects.c).features)
		.enter()
		.append("div")
		.attr("id",function(d){
			symbols.set(d.id, path.centroid(d));
			labels.set(d.id, d.properties.name);
			 })

// ***************************************************************************   
// HEADER ********************************************************************
// *************************************************************************** 

var header = d3.select("#header");
header.append("p")
	.attr("class","item-header")
	.append("a")
 	.attr("href", "https://github.com/neocarto/geomedia")
	.attr("target","_blank")
	.html("Sources");
header.append("p")
	.attr("class","item-header")
	.append("a")
 	.attr("href", "#")
	.attr("target","_blank")
	.html("Methods");
header.append("p")
	.attr("class","item-logo")
	.html("<img src='img/geomedia_logo.png'></img>");

// ***************************************************************************   
// MENU **********************************************************************
// *************************************************************************** 

var menu =  d3.select("#menu")


// Default values
myrss="en_AUS_austra_int";
myrsslabel="the australian";
mycountry="FRA";
mycountrylabel="France";
myweek = 1;
mymodel="grav";
myfile = myrss+"_"+mycountry+"_"+myweek+"_"+mymodel 

// Newspapers

menu.append("h2").html("<li><span id ='rss-title'>Newspapers</span></li>")
menu.append("div").attr("id","menu-rss").append("select")
	.attr("id","select-rss")
	.attr("style","width:250px ; height:100px");


$.getJSON('database/output/feeds.json', null, function(data) {
    $.each(data, function(i, item) {
    $( "#select-rss" ).append("<option selected value = "+item.id+" selected>"+item.name+"</option>");
   });
});



menu.append("div").attr("id","spacerss").append("br")
menu.append("div").attr("id","allrss")
d3.select("#allrss").html("<input type='checkbox' id='checkrss' name='checkrss'><label for='checkrss' id ='labelcheckrss'>Select All</label>")
$( "#allrss" ).buttonset();


$("#checkrss").change(function() {
    if(this.checked) {
	$("#menu-rss").hide();
	$("#spacerss").hide();
	$("#rss-title").empty();
	$("#rss-title").append("Newspapers (All)");
	$( "#allrss" ).buttonset( "destroy" );
	$("#labelcheckrss").html("Choose one");
	$( "#allrss" ).buttonset();
    myrss_tmp = myrss;  
    myrss = "0";
	}
    else {
	$("#menu-rss").show();
	$("#spacerss").show();
	$("#rss-title").empty();
	$("#rss-title").append("Newspapers");
	$( "#allrss" ).buttonset( "destroy" );
	$("#labelcheckrss").html("Select All");
	$( "#allrss" ).buttonset();
    myrss = myrss_tmp ;
	}
    submit();
    
});

$("#select-rss").selectmenu({ change: function(event, ui) { 
    myrss = ui.item.value; 
    submit();
    
}});


// Weeks

menu.append("div").attr("id","menu-date-title").append("h2").html("<li>Week <span id='nbweek'>"+myweek+"</span> of 2014</li>")
menu.append("div").attr("id","menu-date")


  $(function() {
    $( "#menu-date" ).slider({
      range: "max",
      min: 1,
      max: 52,
      step:1,	
      value: myweek,
      slide: function( event, ui ) {
        $( "#nbweek" ).html( ui.value );
	myweek =  ui.value;
          submit();
      }
           
    });
  $( "#nbweek" ).val( $( "#menu-date" ).slider( "value" ) );

  });
menu.append("div").attr("id","spaceweeks").append("br")
week = 1;

menu.append("div").attr("id","allweeks")
d3.select("#allweeks").html("<input type='checkbox' id='checkweek' name='checkweek'><label for='checkweek' id ='labelcheckweek'>Select all</label>")
$( "#allweeks" ).buttonset();

$("#checkweek").change(function() {
    if(this.checked) {
	$("#menu-date").hide();
	$("#spaceweeks").hide();
	$("#nbweek").empty();
	$("#nbweek").append("(All)");
	$( "#allweeks" ).buttonset( "destroy" );
	$("#labelcheckweek").html("Choose one");
	$( "#allweeks" ).buttonset();
    myweek_tmp = myweek;  
    myweek = 0;
    }
    else {
	$("#menu-date").show();
	$("#spaceweeks").show();
   	myweek = myweek_tmp;
    	$("#nbweek").empty();
	$("#nbweek").append(myweek);
	$( "#allweeks" ).buttonset( "destroy" );
	$("#labelcheckweek").html("Select All");
	$( "#allweeks" ).buttonset();
	}
   submit();
});

// Model

menu.append("h2").html("Time buffer (nb of weeks)")
menu.append("div").attr("id","radioset")
d3.select("#radioset").html("<input type='radio' id='radio1' name='radiomodel' value = 'grav' checked='checked'><label for='radio1'>Gravitaire</label><input type='radio' id='radio2' value = 'alea' name='radiomodel'><label for='radio2'>Al√©atoire</label><input type='radio' id='radio3' value = 'mod3' name='radiomodel'><label for='radio3'>Model 3</label>")
$( "#radioset" ).buttonset();

$("#radioset").change(function(){
	mymodel = $("input[name='radiomodel']:checked").val();
    	submit();

});


// Submit
 
function submit() { 
    
    fileobs = myrss+"/obs.tsv";
    console.log(fileobs);
    console.log(myweek);
    myfile = myrss+"_"+myweek+"_"+mymodel
    //console.log(myfile); 
    
    //plotPropCircles("database/test/datatest1.tsv",0.3,"stock","red",myfile)
    
	plotPropChoroCircles("database/test/datatest1.tsv","stock2","ratio2",0.2, 8,"Reds","coucou")	
};

// Map configuration
menu.append("br")
menu.append("br")
menu.append("h2").html("Map configuration")

// Rotate
menu.append("li").html("base map rotation")
menu.append("input").attr("type", "range").attr("id","form_rotate").attr("value",0).attr("min",0).attr("max",360).attr("step",1)

d3.select("#form_rotate").on("input", function() { 
    projection.rotate([eval(this.value),0,0]);
    svg.selectAll("path").attr("d", path);         
    svg.data(topojson.feature(world,world.objects.c).features).enter().append("circle").attr("id",function(d){ symbols.set(d.id, path.centroid(d))})
    svg.select("#propsymbols").selectAll("circle")
    .attr("cx", function(d) {  if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[0]} else {return "NaN"} })
    .attr("cy", function(d) {  if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[1]} else {return "NaN"} })
}); 

// Sizes
menu.append("li").html("Symboles sizes")
menu.append("input").attr("type", "range").attr("id","form_sizes").attr("value",1).attr("min",0.1).attr("max",2).attr("step",0.1)

d3.select("#form_sizes").on("input", function() {
    k = this.value;
    formsize = eval(k);	
    d3.select("#propsymbols").selectAll("circle")
    .attr("r", function(d) { return radius(d[1]*k*size)} );
    });             



// ***************************************************************************   
// BASEMAP FUNCTION **********************************************************
// *************************************************************************** 
   
function plotLayout() {
    
    var graticule = d3.geo.graticule();
    var defs = svg.append("defs");

    defs.append("clipPath")
        .attr("id", "clip")
        .append("use")
        .attr("xlink:href", "#sphere");

    svg.append("defs").append("path")
        .datum({type: "Sphere"})
        .attr("id", "sphere")
        .attr("d", path)
        .style("fill", "url(#radial-gradient)")
        .style("stroke","none") ;

    svg.append("use")
        .attr("class", "stroke")
        .attr("xlink:href", "#sphere");

    svg.append("g").attr("id","grat").append("path")
        .datum(graticule)
        .attr("class", "graticule")
        .attr("clip-path", "url(#clip)")
        .attr("d", path);
    
	svg.append("g")
		.attr("id","countries")
		.attr("class", "land")
		.selectAll(".subunit")
		.data(topojson.feature(world, world.objects.w).features)
		.enter().append("path")
		.attr("d", path)
		.attr("clip-path", "url(#clip)")  

	svg.append("g")
        .attr("id","coasts")
	    .append("path")
	    .datum(topojson.merge(world, world.objects.w.geometries))
	    .attr("class", "coasts")
	    .attr("d", path)
	    .attr("clip-path", "url(#clip)")  
    
}


// ***************************************************************************   
// PROP SYMBOLS FUNCTION **********************************************************
// ***************************************************************************    

function plotPropCircles(file,k,field, pallette, maptitle) {
	
	svg.select("#propsymbols").remove();
	svg.select("#legend").remove();
	svg.select("#legtitle").remove();
	svg.select("#title").remove();
	
	var stockById = d3.map()
       	stockById2 = [];
	var myfieldstock = "d."+field;

	// Files to load    
	 queue()
  	 .defer(d3.tsv, file, function(d) { stockById2.push([d.id, +eval(myfieldstock)])  })
     .await(ready);
	function ready(error, data) {

	  if (error) throw error;
	stockById2 = stockById2.sort(function(a,b){return a[1] < b[1]})
	  svg.append("g")
		.attr("id", "propsymbols")
		.attr("class","circles")
		.selectAll("circle")
		.data(stockById2)
		.enter().append("circle")
		.attr("id", function(d) { return d[0]; })
	 	.attr("cx", function(d) { if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[0]} else {return "NaN"} })
		.attr("cy", function(d) { if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[1]} else {return "NaN"} })
        .attr("r", function(d) { return radius(d[1]*k*formsize); })
    	.call(d3.helper.tooltip()
                .style({color: 'white', border:'2', background: '#7A776E', padding:'5px' })
                .text(function(d){
			return labels.get(d[0])+"<br/>"+d[1]; 
		})
            )
        .on('mouseover', function(d){
            d3.select(this).style({fill: "#ffc914", cursor:"pointer"});
        })
        .on('mouseout', function(d){
            d3.select(this).transition().duration(250).style("fill", function(d) {d.class});
        })
	.on('click', function(d){
		myid = d3.select(this).attr("id");
		mylabel = labels.get(myid);
		$( "#dialog" ).dialog( "open" );
		$( "#dialog" ).dialog('option', 'title', mylabel + " (" + myid + ")");
		$( "#dialog" ).html("<p>Here display a word cloud for: " + myfile + "</p>");
		plotWordCloud("database/output/tagexample.tsv")

    });
    
} 
  size = eval(k);


var posx = width/2; var posy = 50;
svg.append("g").append("text").attr("id","title").text(maptitle)
.attr("x", posx).attr("y", posy)
.style({"font-size":"25px", "fill":"#6B8087","font-family":"arial, tahoma, geneva, sans-serif","font-style":"bold"})
.attr("text-anchor","middle");  

}


// ***************************************************************************   
// PROP SYMBOLS CHORO FUNCTION ***********************************************
// ***************************************************************************    

function plotPropChoroCircles(file,stock,ratio,k, nbreaks,palette,maptitle) {
	 
	svg.select("#propsymbols").remove();
	svg.select("#legend").remove();
	svg.select("#legtitle").remove();
	svg.select("#title").remove();
	
	var stockById = d3.map()
	var rateById = d3.map()
       	stockById2 = [];
	var myfieldstock = "d."+stock;
	var myfieldratio = "d."+ratio;

	// Files to load    
	 queue()
  	 .defer(d3.tsv, file, function(d) { stockById2.push([d.id, +eval(myfieldstock)]) ; rateById.set(d.id, +eval(myfieldratio))  })
     .await(ready);
	function ready(error, data) {

	  if (error) throw error;



	// ***** Discretization *****

    var serie = new geostats(rateById.values());
    breaks = (serie.getQuantile(nbreaks));
    b = (serie.getQuantile(nbreaks));
    b.splice(nbreaks,1);
    b.splice(0,1); 

   
    var quantize = d3.scale.threshold()
    .domain(b)
    .range(d3.range(nbreaks).map(function(i) { return "q" + i + "-" + nbreaks; }));


	stockById2 = stockById2.sort(function(a,b){return a[1] < b[1]})
	  svg.append("g")
		.attr("id", "propsymbols")
 		.attr("class",palette + " bubble")
		.selectAll("circle")
		.data(stockById2)
		.enter().append("circle")
		.attr("class", function(d) { return quantize(rateById.get(d[0]));   })
		.attr("id", function(d) { return d[0]; })
	 	.attr("cx", function(d) { if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[0]} else {return "NaN"} })
		.attr("cy", function(d) { if(typeof symbols.get(d[0]) != 'undefined') {return symbols.get(d[0])[1]} else {return "NaN"} })
        .attr("r", function(d) { return radius(d[1]*k*formsize); })
    	.call(d3.helper.tooltip()
                .style({color: 'white', border:'2', background: '#7A776E', padding:'5px' })
                .text(function(d){
			return labels.get(d[0])+"<br/>stock: "+d[1]+"<br/>ratio: "+rateById.get(d[0]); 
		})
            )
        .on('mouseover', function(d){
            d3.select(this).style({fill: "#ffc914", cursor:"pointer"});
        })
        .on('mouseout', function(d){
            d3.select(this).transition().duration(250).style("fill", function(d) {d.class});
        })
	.on('click', function(d){
		myid = d3.select(this).attr("id");
		mylabel = labels.get(myid);
		$( "#dialog" ).dialog( "open" );
		$( "#dialog" ).dialog('option', 'title', mylabel + " (" + myid + ")");
		$( "#dialog" ).html("<p>Here display a word cloud for: " + myfile + "</p>");
		plotWordCloud("database/output/tagexample.tsv")

    });


// ***** Legend *****  
    
//    var legtitle = "Title of the legend";
//    var xpos = 20;
//    var ypos = 300;
//    var boxwidth = 25;
//    var boxheight = 20;
//    var boxgap = 20;
    
//    var legend = d3.select("svg").append("g").attr("id","legend");
//    legend.append("g").attr("id","boxes").attr("class",palette)
//    .selectAll('legendEntry')
//    .data(quantize.range().reverse())
//    .enter()
//    .append('rect')
//    .attr("x", xpos)
 //   .attr("y", function(d, i) {
//       return i * boxgap + ypos + boxgap*2;
//    })
//   .attr("width", boxwidth)
//   .attr("height", boxheight)
//   .attr("class", function(d){return d;});
    
//    legend.append("g").attr("id","boxestextes")
//    .selectAll('legendEntry')
//    .data(breaks.reverse())
//    .enter()
//    .append('text')
//    .attr("x", xpos + boxwidth + boxgap/2)
//    .attr("y", function(d, i) {
//       return i * boxgap + ypos + boxgap*2;
//    })
//    .text(function(d, i) {
//       return breaks[i].toFixed(0);
//    })
//    .style({'alignment-baseline': 'middle' , 'font-size':'10'});
//        
//    legend.append("g").attr("id","legendtitle").append('text').text(maptitle).attr("x", xpos).attr("y", ypos+boxgap);   
//    

} 
  size = eval(k);


var posx = width/2; var posy = 50;
svg.append("g").append("text").attr("id","title").text(maptitle)
.attr("x", posx).attr("y", posy)
.style({"font-size":"25px", "fill":"#6B8087","font-family":"arial, tahoma, geneva, sans-serif","font-style":"bold"})
.attr("text-anchor","middle");  


}

            
            
            
            

// ***************************************************************************   
// POPUP WORDCLOUD ***********************************************************
// ***************************************************************************    


  $(function() {
    $( "#dialog" ).dialog({
      autoOpen: false,
        maxWidth:500,
        maxHeight: 500,
        width: 500,
        height: 500,
      show: {
        effect: "blind",
        duration: 1
      },
      hide: {
        effect: "explode",
        duration: 1
      }
    });
 
  });

function plotWordCloud(file) {

  var width = 450, height= 400; 	
  var mytagsScale = d3.scale.linear().range([10,60]);
  var fill = d3.scale.category20();	

  d3.tsv(file, function(data){
	var mytags = data
	.filter(function(d){return +d.nb > 0;})
	.map(function(d){ return {text : d.word, size: +d.nb};})
	.sort(function(a,b){return d3.descending(a.size,b.size);})
	.slice(0,100);
  mytagsScale.domain([
	d3.min(mytags, function(d){return d.size}),
	d3.max(mytags, function(d){return d.size})
]);

  d3.layout.cloud().size([width, height])
      .words(mytags)
      .rotate(function() { return ~~(Math.random() * 2) * 90; })
      .font("Impact")
      .fontSize(function(d) { return mytagsScale(d.size); })
      .on("end", draw)
      .start();

	});

  function draw(words) {
    d3.select("#dialog").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate("+(width/2)+","+(height/2)+")")
      .selectAll("text")
        .data(words)
      .enter().append("text")
        .style("font-size", function(d) { return d.size + "px"; })
        .style("font-family", "Impact")
        .style("fill", function(d, i) { return fill(i); })
        .attr("text-anchor", "middle")
        .attr("transform", function(d) {
          return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
        })
        .text(function(d) { return d.text; });
  }
}


// DISPLAY BASEMAP            
plotLayout()
// DISPLAY FIRST CIRCLES LAYER
//plotPropCircles("database/test/datatest1.tsv",0.2,"stock","red",myfile)   
plotPropChoroCircles("database/test/datatest1.tsv","stock2","ratio2",0.2, 8,"Reds",myfile)     
} 

</script>
